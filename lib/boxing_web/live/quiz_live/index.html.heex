<div id="start" class="max-w-3xl mx-auto" phx-hook="Timer">
  <%= if @prefight do %>
    <div class="text-center mt-8 pb-24 text-2xl max-w-xl mx-auto">
      <img
        src={~p"/images/stats.png"}
        alt="llama 2 vs gpt-3.5 fight preview"
        class="rounded-lg shadow-2xl border-4 border-red-500 my-8"
      />
      <div class="prose">
        <p>
          <a class="underline" href="https://ai.meta.com/llama/">Llama2</a>
          has taken the world by storm. Many have
          claimed <a class="underline" href="https://news.ycombinator.com/item?id=36778932">performance similar to OpenAI's GPT-3.5</a>.
        </p>
        <p>Each round, pick the output you think is better. Each model has 10 hitpoints.</p>
        <p>Enough talk. Let's settle this in the ring.</p>

        <button
          phx-click="start"
          class="mt-6 text-white bg-red-600 px-4 py-2 rounded-lg hover:bg-red-500"
        >
          Start Fight
        </button>
      </div>
    </div>
  <% else %>
    <div class="font-fight">
      <div class="">
        <dl class="mt-5 grid gap-5 grid-cols-2">
          <%= for {score, i} <- @score |> Enum.with_index() do %>
            <div
              id={"hp-#{score.js_name}"}
              class={"#{if i == 1, do: "text-right"} hp overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6"}
            >
              <dt class="truncate text-sm font-medium text-gray-500">
                <%= score.human_name %>
              </dt>
              <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">
                <%= score.health %> Hit Points
                <div class={"#{if i == 1, do: "transform scale-x-[-1]"} w-full bg-red-200 rounded-full h-2.5 mb-4"}>
                  <div
                    class="bg-blue-600 h-2.5 rounded-full"
                    style={"width: #{score.health * 20}%"}
                  >
                  </div>
                </div>
              </dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>

    <div class="mt-16">
      <h5 class="text-xl sm:text-4xl font-bold">
        "<%= String.replace(
          @text_prompt,
          ". Answer as succintly as possible. Maximum response length of 1 paragraph.",
          ""
        ) %>"
      </h5>
    </div>

    <div id="results" phx-hook="Confetti" class="mt-6">
      <h5 :if={not @show_results} id="header" phx-hook="Bell" class="text-xl text-gray-700">
        Which is a better response? <span>(Models are shuffled each round)</span>
      </h5>

      <%= if @show_results do %>
        <div class="text-center mx-auto my-10 font-bold">
          <%= if is_nil(@winner) do %>
            <button
              type="button"
              id="copy-question"
              phx-hook="CopyLinkToClipboard"
              class="font-fight mt-6 text-black bg-white px-4 py-2 rounded-lg hover:bg-gray-100 border-2"
            >
              Copy Link to Question
            </button>

            <button
              id="next"
              class="font-fight mt-6 text-white bg-red-600 px-4 py-2 rounded-lg hover:bg-red-500"
              phx-click="next"
            >
              Next Round &rarr;
            </button>
          <% else %>
            <div class="mt-6">
              <.link
                class="font-fight text-white bg-red-600 px-4 py-2 rounded-lg hover:bg-red-500"
                navigate="/"
              >
                Play Again
              </.link>
            </div>
          <% end %>

          <p class="mt-6">Round Winner: <%= @round_winner.model %></p>

          <%= if @round_winner.model |> String.contains?("llama") do %>
            <img
              class="h-44 rounded-lg mx-auto mt-4"
              src={~p"/images/llama.png"}
              alt="llama boxing"
            />
          <% else %>
            <img
              class="h-44 rounded-lg mx-auto mt-4"
              src={~p"/images/gpt.png"}
              alt="gpt-3.5 boxing"
            />
          <% end %>
        </div>
      <% end %>

      <div class="grid grid-cols-2 gap-4 mt-10">
        <%= for {prompt, i} <- @prompts |> Enum.with_index() do %>
          <div class="overflow-y-scroll border text-xs sm:text-base font-mono rounded-lg relative p-4 shadow-lg hover:shadow-xl hover:bg-gray-100">
            <button
              class="text-left"
              phx-click={
                JS.push("select")
                |> JS.add_class("shake", to: "#hp-#{other_model(prompt.model)}")
              }
              phx-value-id={prompt.id}
              phx-value-submission-id={prompt.submission_id}
            >
              <p class="model font-bold mb-4">
                <%= if @show_results,
                  do: prompt.model,
                  else: "This is better" %>

                <%= if not is_nil(@round_winner) and @round_winner.model == prompt.model do %>
                  <span class="text-green-600">ðŸŽ‰ Round Winner ðŸŽ‰</span>
                <% end %>
              </p>

              <p class="whitespace-pre-line"><%= prompt.completion %></p>
            </button>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%= if @winner do %>
    <.modal id="winner" show>
      <div>
        <.header>
          <%= @winner.human_name %> wins!
        </.header>
        <div class="mt-4">
          <span id="scoreboard">
            LLM Boxing Results: <br />
            <%= for emoji <- @vote_emojis do %>
              <%= emoji %>
            <% end %>
          </span>
          <div class="mt-12 grid grid-cols-2 gap-4">
            <.button id="CopyClipboard" phx-hook="CopyToClipboard">Copy Results</.button>
            <div>
              <.link href="https://replicate.com/replicate/llama70b-v2-chat?utm_campaign=llmboxing&utm_source=project">
                <.button>
                  Are you a developer? Run Llama2 Replicate &rarr;
                </.button>
              </.link>
            </div>
          </div>

          <div class="mt-6"></div>
        </div>
      </div>
    </.modal>
  <% end %>
</div>
